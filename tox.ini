[tox]
min_version = 4.0
env_list =
    py{39,310,311,312}
    lint
    type
    security
    docs
isolated_build = true

[testenv]
description = Run tests with pytest
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-xdist>=3.3.0
    pytest-timeout>=2.2.0
commands =
    pytest {posargs:tests}

[testenv:coverage]
description = Run tests with coverage
deps =
    {[testenv]deps}
    coverage[toml]>=7.3.0
commands =
    pytest --cov=pytorch_teaching --cov-report=html --cov-report=term --cov-report=xml {posargs:tests}

[testenv:lint]
description = Run linting with ruff
skip_install = true
deps =
    ruff>=0.1.0
commands =
    ruff check src tests

[testenv:format]
description = Format code with black
skip_install = true
deps =
    black>=23.7.0
commands =
    black src tests

[testenv:format-check]
description = Check code formatting
skip_install = true
deps =
    black>=23.7.0
commands =
    black --check src tests

[testenv:type]
description = Run type checking with mypy
deps =
    mypy>=1.5.0
    types-PyYAML>=6.0.0
    types-tqdm>=4.66.0
commands =
    mypy src

[testenv:security]
description = Run security checks with bandit
skip_install = true
deps =
    bandit[toml]>=1.7.5
commands =
    bandit -r src -ll

[testenv:docs]
description = Build documentation
deps =
    mkdocs>=1.5.0
    mkdocs-material>=9.0.0
    mkdocstrings[python]>=0.22.0
commands =
    mkdocs build

[testenv:dev]
description = Development environment
deps =
    {[testenv]deps}
    {[testenv:lint]deps}
    {[testenv:format]deps}
    {[testenv:type]deps}
    {[testenv:security]deps}
    ipython>=8.14.0
    ipdb>=0.13.13
commands =
    python -m pip list

[testenv:clean]
description = Clean build artifacts
skip_install = true
allowlist_externals =
    rm
    find
commands =
    rm -rf build dist *.egg-info htmlcov .coverage coverage.xml .pytest_cache .mypy_cache .ruff_cache
    find . -type d -name __pycache__ -exec rm -rf {{}} +
    find . -type f -name "*.pyc" -delete
